# Headline

Apply input validation and structured URL practices when using URLs or
generating URLs from user-supplied data.

# Key Benefits

Technology growth on the Web has changed the way customers and partners communicate
and interact with each other. The ubiquity and complexity, compounded with flaws
in the infrastructure, have made the Web vulnerable to attack. URL Injection is an
attack type that can severely affect user's communication and interaction.

Failure to correctly validate URLs or not performing URLs input validation
exposes the program to a large class of attack opportunities and unintended
consequences. For Web applications, input validation means to check on the
server side that the input supplied by the user is of the form expected by
the program.

URL input validation ensures input passed to the code results in code behavior
that conforms to Cisco's designed intent, thereby preventing attacks that
can severely affect an organization's infrastructure and cause financial and
reputational damage.

Validating URL input prevents the following kinds of attacks:

* Users can be redirected to an untrusted page that contains "drive by"
  malware that then compromises the program. This will expose the program to
  attacks that can lead to stealing credentials, personally identifiable
  information (PII), or other important data. The program interaction with
  the web server and other system applications can also be compromised.
* Users can be subjected to phishing attacks by being redirected to an
  untrusted page. The phishing attack can point to a client-controlled
  web page that appears to be a trusted web site. The phishers can then
  steal the user's credentials and then use these credentials to access
  the legitimate web site.
* Maliciously crafted URLs in redirect and forward attacks can be used
  to hijack the user's authentication and enable the attacker to
  impersonate the user to access and perform privileged functions as that
  user.

# Description

SEC-VAL-INURL provides technical requirements for preventing URL injection
attacks. In addition, SEC-VAL-INURL provides available implementation options,
tools for validation and references to background material.

A URL injection vulnerability is one in which an offering
constructs URLs using client-supplied input that is malformed in ways to
allow the client to have control of the actual URL accessed. The program
can enable adversaries to access unauthorized services, or to process
client-supplied data in URLs.

Notice that this can happen if the program retrieves data using URLs, even
if the offering is not a Web application. The program validates
client-supplied data in URLs by applying input validation practices.

# Behavior

## SEC-VAL-INURL-FR1: URL's generated by the program

Applies when URL is generated by the program.

1. The program _MUST_ apply input validation practices, if the program uses
   URLs or generates URLs from client-supplied data.
1. The program _MUST_ canonicalize hexadecimal encoding in the client-supplied
   data before doing any validation or authorization checks.
1. For the purpose of resilience in validation or authorization checks,
   the program _MUST_ convert case-sensitive data to the canonical form (lower case),
   such as the scheme and the host subcomponent of the authority component.
1. Applications _MUST NOT_ construct URLs from client-supplied data using
   general-purpose string manipulation functions. Construct URLs using code
   dedicated to URL creation.
1. If the offering uses a framework or library that provides URL construction
   functions, the program _SHOULD_ use those functions and _MAY_ use "wrapping"
   to add additional controls not included in this list.

## SEC-VAL-INURL-FR2: URL's supplied by an untrusted client.

Applies when URL is supplied by the user or an untrusted client.

1. If a single string in the user-supplied data includes an entire URL or more
   than one component of a URL, then the program _MUST_ parse the string into
   components and subcomponents and reconstruct the final URL from the
   extracted values.
1. The program _MUST_ construct each URL using code
   that checks that each component and subcomponent has legal syntax,
   and that none of components and subcomponents might be mis-parsed to
   contain another.

## SEC-VAL-INURL-FR3: Verify components and subcomponents

Applies whenever URL components and subcomponents are verified.

1. If the program copies client-supplied data into the scheme component of a
   URL, the program _MUST_ verify it by exact matching against a AllowList of
   expected schemes. The only scheme on the AllowList _SHOULD_ be "https".
   Other schemes _MAY_ be on the AllowList, if expected by the program.
1. If the program copies client-supplied data into the authority component,
   the program _MUST_ verify each subcomponent.
1. The program _MUST_ verify any host subcomponent against a AllowList of
   expected fully qualified domain names. The program _MUST_ reject any
   non-fully qualified host names.
1. The program _MUST_ verify any port subcomponent against a AllowList of
   expected port numbers. If the port subcomponent explicitly specifies
   the scheme's default port, then the port subcomponent _MUST_ be removed
   entirely.
1. The program _MUST NOT_ accept any user info subcomponent unless it is
   needed in the application. If you do accept a userinfo subcomponent,
   it _MUST_ be treated as a credential.
1. If the program copies client-supplied data into the path component
   of a URL, the program _MUST_ make sure that the path begins with
   exactly one slash character.
1. If the authority component points to a server that is, or _MAY_
    be, part of the offering, then the program _MUST_ verify that the
    source of the client-supplied data is authorized to access that path.
1. The program _SHOULD NOT_ allow client-supplied data to specify the query
   component. If it does, the program _SHOULD_ parse the query parameter
   string and allow only expected parameters and values.
1. If the Web application framework uses client-side code
   that interprets fragment components as data in some structured
   language, or if the URL the program is constructing might be passed
   to such code, then the program _SHOULD NOT_ construct fragment components
   from client-supplied data. If it does, the program _MUST_ apply the
   protections described in SEC-VAL-CLNIN.

## SEC-VAL-INURL-FR4: URL's supplied by an authorized source

Applies when the source is authorized.

1. The program _SHOULD NOT_ generate or use a URL that includes any
   user-supplied data, not even sanitized fragments. If it does, the
   program still _SHOULD NOT_ use such a URL with any HTTP method.
   The program _MAY_ link to URLs based on client-supplied data but the
   program _MUST NOT_ embed them.
1. If the program does generate a URL from user-supplied data, then, in
   addition to applying input validation practices, the following
   applies:
    1. If the program is used to construct a URL to be supplied to a Web
       user agent as part of a document, then the program _SHOULD NOT_
       embed that URL in the document in any way that might cause it to be
       retrieved, its contents to be rendered without intentional user
       action, or using any HTTP method.
    1. If the source of the client-supplied data used to construct a URL is
       an agent authenticated to represent a specific principal, then the
       program _MAY_ embed that URL in documents returned to other user agents
       authenticated to represent the same principal, or agents for which
       the program knows that principal to represent the controlling policy
       entity.
1. The program _SHOULD NOT_
   allow client-supplied data to cause the program to access a host
   unless the program has specific reason to believe the entity
   providing the suspect data is authorized to connect to that host.
1. The program _MAY_ accept any fully qualified domain name supplied by an agent
   authenticated to represent a specific principal provided the
   only use the program makes of that URL is to include it in documents
   sent to other agents authenticated to represent the same principal,
   or agents for which the program knows that principal to represent the
   controlling policy entity.
1. The program _MUST NOT_ accept any explicit port specification unless the
   program has specific reason to believe the entity providing the input
   is authorized to connect to that port on the specified host.
1. If an URL enters across a trust boundary, the receiving application
   _MUST_ validate the inbound URL. Application trust boundaries are identified
   through Threat Modeling.

# Informative References

* FedRAMP Security Controls - [FedRAMP Security Controls Baseline](https://www.fedramp.gov/assets/resources/documents/FedRAMP_Security_Controls_Baseline.xlsx)
* OWASP Project - [OWASP Mutillidae 2 Project](https://www.owasp.org/index.php/OWASP_Mutillidae_2_Project)
* RegExp Security - [Cheat Sheet Series](https://github.com/attackercan/regexp-security-cheatsheet/blob/master/README.md)
* JSON Schema Validation - [A Vocabulary for Structural Validation of JSON](https://json-schema.org/latest/json-schema-validation.html#rfc.section.2)
* CSCvm81627 - [URL Filtering Denial of Service Vulnerability](https://cdetsng.cisco.com/webui/#view=CSCvm81627)
* CSCuv47565 - [URL Handling DoS Vulnerability](https://cdetsng.cisco.com/webui/#view=CSCuv47565)
* CSCvo01349 - [URL Filter Bypass Vulnerability](https://cdetsng.cisco.com/webui/#view=CSCvo01349)
* CSCvm81627 - [URL Filtering Denial of Service Vulnerability](https://cdetsng.cisco.com/webui/#view=CSCvm81627)
* NIST National Vulnerability Database - [URL Injection Vulnerability](https://nvd.nist.gov/)

# Requirement References

    ---
    source: PSB
    foreign_id: SEC-VAL-CLNIN
    relation: connects
    headline: Input Validation

# Attributes

    id: SEC-VAL-INURL
    version: 2
    issueref: ISS_Inject
    category: Threat Surface Reduction
    riskArea: Application & Interface Security
    legallysensitive: false
    waivable: true
    applicability:
      - force: mandatory
        target:
          restrict: >
            [offerings](#DEF_Offering)
          class: HasWebUi_OR_ProtoHttp
    priority: 10
    phase: requirements
    tags:
    - Critical PSB
    - CloudCritical
    - EN/PI
    - PSB/OnPrem
    - Cloud
    - FAST
